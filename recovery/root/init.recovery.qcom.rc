# -----------------------------------------------------------------------------
# Qualcomm Recovery Init – Spacewar (Nothing Phone 1)
# Optimized for Vendor Boot & Module Loading
# -----------------------------------------------------------------------------

import /init.recovery.qcom_decrypt.rc

# -----------------------------------------------------------------------------
# Init
# -----------------------------------------------------------------------------
on init
    write /sys/class/backlight/panel0-backlight/brightness 200
    setprop sys.usb.configfs 1

    # Firmware klasörlerini oluştur (Decryption için gerekli olabilir)
    mkdir /firmware
    mkdir /vendor/firmware_mnt

# -----------------------------------------------------------------------------
# Filesystem & Module Loading (KRİTİK BÖLÜM)
# -----------------------------------------------------------------------------
on fs
    # 1. Bootdevice Symlink (Sistemin diskleri bulması için şart)
    wait /dev/block/platform/soc/${ro.boot.bootdevice}
    symlink /dev/block/platform/soc/${ro.boot.bootdevice} /dev/block/bootdevice

    # 2. Vendor DLKM'yi Mount Et
    # (Önce klasörü oluştur, sonra bölümü bağla)
    mkdir /vendor_dlkm
    wait /dev/block/bootdevice/by-name/vendor_dlkm${ro.boot.slot_suffix}
    mount erofs /dev/block/bootdevice/by-name/vendor_dlkm${ro.boot.slot_suffix} /vendor_dlkm ro

    # 3. Kernel Modüllerini Yükle (device.mk listesine göre)
    # Dokunmatik ve ekranın çalışması için bu sıra çok önemli!
    
    # Temel Grafikler ve DRM
    insmod /vendor_dlkm/lib/modules/msm_drm.ko
    
    # İşlemci ve DSP Haberleşmesi
    insmod /vendor_dlkm/lib/modules/q6_pdr_dlkm.ko
    insmod /vendor_dlkm/lib/modules/q6_notifier_dlkm.ko
    insmod /vendor_dlkm/lib/modules/adsp_loader_dlkm.ko
    
    # Sensörler (Bazen ekran döndürme için gerekir)
    insmod /vendor_dlkm/lib/modules/sensors_ssc.ko
    
    # Pil ve Şarj (Recovery'de şarj göstergesi için)
    insmod /vendor_dlkm/lib/modules/qti_battery_charger_main.ko
    
    # DOKUNMATİK EKRAN (En kritiği bu)
    insmod /vendor_dlkm/lib/modules/fts_tp.ko

# -----------------------------------------------------------------------------
# Decryption fallback
# -----------------------------------------------------------------------------
on property:prepdecrypt.vendor_mounted=1
    setprop crypto.ready 1

# Extra safety for some ROMs
on property:ro.crypto.state=encrypted
    setprop crypto.ready 1

# -----------------------------------------------------------------------------
# Boot
# -----------------------------------------------------------------------------
on boot
    setprop sys.usb.config adb
